<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Ropa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS CSS --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout & Grid */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .p-4 { padding: 1rem; }
        .m-2 { margin: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .w-full { width: 100%; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        
        /* Componentes UI */
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-secondary { background-color: #9ca3af; color: white; }

        input, select, textarea { padding: 0.7rem; border: 1px solid var(--border); border-radius: 0.5rem; width: 100%; box-sizing: border-box; margin-bottom: 0.8rem; font-family: inherit; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.3rem; color: #4b5563; }

        .card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        /* Tablas */
        .table-container { overflow-x: auto; background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 1rem; border-bottom: 1px solid var(--border); }
        th { background-color: #f8fafc; font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:hover { background-color: #f1f5f9; }

        /* Login */
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #e0f2fe 0%, #f3f4f6 100%); }
        
        /* Navegación */
        header { background: white; padding: 1rem 1.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .nav-tabs { display: flex; gap: 0.5rem; padding: 0.5rem 1rem; background: white; overflow-x: auto; border-bottom: 1px solid var(--border); }
        .nav-tab { padding: 0.75rem 1.25rem; cursor: pointer; border-radius: 0.5rem; color: #64748b; font-weight: 500; transition: all 0.2s; white-space: nowrap; }
        .nav-tab:hover { background-color: #f1f5f9; color: var(--primary); }
        .nav-tab.active { background-color: #eff6ff; color: var(--primary); font-weight: 700; }

        /* Buscador Resultados */
        .search-result-item { padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; margin-bottom: 0.5rem; transition: border-color 0.2s; cursor: pointer; }
        .search-result-item:hover { border-color: var(--primary); background-color: #f8fafc; }
        
        /* Estados */
        .badge { padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-solicitado { background-color: #e0f2fe; color: #0369a1; }
        .badge-efectivo { background-color: #dcfce7; color: #15803d; }
        .badge-cancelado { background-color: #fee2e2; color: #b91c1c; }
        .badge-alistado { background-color: #fef3c7; color: #b45309; }
        .badge-enviado { background-color: #e0e7ff; color: #3730a3; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        /* Autocomplete List */
        .autocomplete-list { border: 1px solid #d1d5db; border-radius: 0.375rem; max-height: 150px; overflow-y: auto; background: white; position: absolute; width: 100%; z-index: 10; margin-top: -0.5rem; }
        .autocomplete-item { padding: 0.5rem; cursor: pointer; font-size: 0.9rem; }
        .autocomplete-item:hover { background-color: #f3f4f6; }

        /* Tabs internas */
        .sub-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem; }
        .sub-tab { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 500; }
        .sub-tab.active { border-bottom-color: var(--primary); color: var(--primary); }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="card" style="width: 100%; max-width: 400px;">
            <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary);">Sistema Ropa</h2>
            <input type="text" id="login-user" placeholder="Usuario">
            <input type="password" id="login-pass" placeholder="Contraseña">
            <button class="btn btn-primary w-full" onclick="sistema.login()">Ingresar al Sistema</button>
            <p style="font-size: 0.8rem; color: gray; text-align: center; margin-top: 1.5rem;">
                <strong>Credenciales Demo:</strong><br>
                admin / 1 (Controller)<br>
                vendedora1 / 1 (Ventas)<br>
                almacen1 / 1 (Almacén)
            </p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <header>
            <div>
                <h1 style="margin:0; font-size: 1.25rem;">Gestión Ropa</h1>
                <span id="user-display" class="text-sm" style="color: gray;"></span>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="sistema.logout()">Cerrar Sesión</button>
        </header>

        <nav class="nav-tabs" id="menu-tabs"></nav>

        <main class="p-4" id="content-area"></main>
    </div>

    <!-- MODAL -->
    <div id="modal-container" class="hidden modal">
        <div class="modal-content" id="modal-body"></div>
    </div>

    <script>
        /** MÓDULO 1: MODELOS */
        class Usuario {
            constructor(id, username, password, rol, nombre) {
                this.id = id; this.username = username; this.password = password; this.rol = rol; this.nombre = nombre;
            }
        }

        class Producto {
            constructor(id, imei, nombre, imagen, tipoTalla, precioRef, estado = 'Activo') {
                this.id = id; this.imei = imei; this.nombre = nombre; this.imagen = imagen; 
                this.tipoTalla = tipoTalla; this.precioRef = precioRef; this.estado = estado;
            }
        }

        class ProductoFisico {
            constructor(id, imei, talla, estado = 'DISPONIBLE') {
                this.id = id; // QR - Alfanumérico
                this.imei = imei; 
                this.talla = talla;
                this.estado = estado; // 'DISPONIBLE', 'ASIGNADO', 'VENDIDO', 'VIAJE'
                this.idPedidoAsignado = null; 
                this.idItemPedido = null; // Link especifico al item del pedido
            }
        }

        class Cliente {
            constructor(telefono, nombre, genero = '', direccion = '') {
                this.telefono = telefono; this.nombre = nombre; this.genero = genero; this.direccion = direccion;
            }
        }

        class Pedido {
            constructor(codigo, info, productos = []) {
                this.codigo = codigo;
                this.info = info; // Objeto con TODA la info (cliente, entrega, pagos, vendedoras)
                this.estado = 'Solicitado'; // Solicitado, Efectivo, Alistado, Enviado, Devuelto, Cerrado, Cancelado
                this.productos = productos; 
                this.fechaCreacion = new Date().toISOString();
            }
        }

        class Viaje {
            constructor(id, idPedido, tipo, fecha, estado = 'Pendiente') {
                this.id = id; this.idPedido = idPedido; 
                this.tipo = tipo; // 'Entrega', 'Retorno'
                this.fecha = fecha; 
                this.estado = estado; // Pendiente, Alistado, Realizado, Cancelado
                this.costo = 0;
            }
        }

        class HistorialCambio {
            constructor(entidad, idEntidad, usuario, accion, detalles) {
                this.fecha = new Date().toLocaleString();
                this.entidad = entidad; this.idEntidad = idEntidad;
                this.usuario = usuario; this.accion = accion; this.detalles = detalles;
            }
        }

        /** MÓDULO 2: BASE DE DATOS */
        class BaseDeDatos {
            constructor() {
                this.storageKey = 'sistemaRopaDB_v3';
                this.data = this.cargarDatos();
            }

            cargarDatos() {
                const data = localStorage.getItem(this.storageKey);
                if (data) return JSON.parse(data);
                return {
                    usuarios: [
                        new Usuario(1, 'admin', '1', 'controller', 'Admin Principal'),
                        new Usuario(2, 'vendedora1', '1', 'vendedora', 'Ana Ventas'),
                        new Usuario(3, 'vendedora2', '1', 'vendedora', 'Bea Ventas'),
                        new Usuario(4, 'almacen1', '1', 'almacen', 'Jefe Almacén')
                    ],
                    productos: [], productosFisicos: [], clientes: [],
                    pedidos: [], viajes: [], historial: []
                };
            }

            guardar() { localStorage.setItem(this.storageKey, JSON.stringify(this.data)); }
            getTabla(tabla) { return this.data[tabla] || []; }
            
            insertar(tabla, item) {
                this.data[tabla].push(item);
                this.guardar();
                return item;
            }

            actualizar(tabla, idField, idValue, nuevosDatos) {
                const index = this.data[tabla].findIndex(i => i[idField] == idValue);
                if (index !== -1) {
                    this.data[tabla][index] = { ...this.data[tabla][index], ...nuevosDatos };
                    this.guardar();
                    return true;
                }
                return false;
            }

            eliminar(tabla, idField, idValue) {
                const index = this.data[tabla].findIndex(i => i[idField] == idValue);
                if (index !== -1) {
                    this.data[tabla].splice(index, 1);
                    this.guardar();
                    return true;
                }
            }
            
            calcularStockVenta(imei, talla) {
                // Stock Físico DISPONIBLE
                const fisicos = this.data.productosFisicos.filter(p => 
                    p.imei === imei && p.talla === talla && p.estado === 'DISPONIBLE'
                ).length;
                
                // Pedidos 'Efectivo' que aún no se han asignado físicamente (reserva lógica)
                let comprometidos = 0;
                this.data.pedidos.forEach(pedido => {
                    if (pedido.estado === 'Efectivo') {
                        pedido.productos.forEach(prod => {
                            if (prod.imei === imei && prod.talla === talla) {
                                // Solo cuenta si NO ha sido alistado ya (si se alistó, ya consumió el fisico)
                                // Simplificación: Asumimos que Efectivo siempre resta
                                comprometidos += parseInt(prod.cantidad);
                            }
                        });
                    }
                });
                
                return Math.max(0, fisicos - comprometidos);
            }
        }

        const db = new BaseDeDatos();

        /** MÓDULO 3: CONTROLADOR */
        const Utils = {
            generarId: () => Math.random().toString(36).substr(2, 9),
            generarIdCorto: () => {
                // Genera ID Alfanumérico aleatorio (Ej: 9X2A1P)
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 6; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            },
            generarCodigoPedido: () => 'PED-' + Math.floor(100000 + Math.random() * 900000),
            fechaHoy: () => new Date().toISOString().split('T')[0],
            obtenerTallasPorTipo: (tipo) => {
                if (tipo === 'A') return ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
                if (tipo === 'B') return ['26', '28', '30', '32', '34', '36'];
                if (tipo === 'C') return ['2', '4', '6', '8', '10', '12', '14', '16'];
                if (tipo === 'A + C') return ['XS', 'S', 'M', 'L', 'XL', 'XXL', '2', '4', '6', '8', '10', '12', '14', '16'];
                if (tipo === 'B + C') return ['26', '28', '30', '32', '34', '36', '2', '4', '6', '8', '10', '12', '14', '16'];
                return ['UNICA'];
            }
        };

        class SistemaController {
            constructor() { this.usuarioActual = null; }

            login() {
                const user = document.getElementById('login-user').value;
                const pass = document.getElementById('login-pass').value;
                const encontrado = db.getTabla('usuarios').find(u => u.username === user && u.password === pass);
                if (encontrado) {
                    this.usuarioActual = encontrado;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('user-display').innerText = `${encontrado.nombre} (${encontrado.rol})`;
                    this.renderMenu();
                } else { alert('Credenciales incorrectas'); }
            }

            logout() {
                this.usuarioActual = null;
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('login-pass').value = '';
            }

            renderMenu() {
                const menu = document.getElementById('menu-tabs');
                menu.innerHTML = '';
                const role = this.usuarioActual.rol;
                const tabs = [];

                if (role === 'controller') tabs.push({ id: 'productos', label: 'Productos' }, { id: 'usuarios', label: 'Usuarios' }, { id: 'historial', label: 'Historial' });
                
                if (role === 'vendedora' || role === 'controller') tabs.push({ id: 'ventas', label: '+ Nuevo Pedido' }, { id: 'clientes', label: 'Clientes' }, { id: 'lista_pedidos', label: 'Pedidos' }, { id: 'catalogo', label: 'Ver Stock' });
                
                if (role === 'almacen' || role === 'controller' || role === 'vendedora') tabs.push({ id: 'viajes', label: 'Viajes / Picking' });
                
                if (role === 'almacen' || role === 'controller') tabs.push({ id: 'almacen_stock', label: 'Ingreso Stock' });

                tabs.forEach(tab => {
                    const btn = document.createElement('div');
                    btn.className = 'nav-tab'; btn.innerText = tab.label;
                    btn.onclick = () => {
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        btn.classList.add('active');
                        this.navegar(tab.id);
                    };
                    menu.appendChild(btn);
                });
                if(tabs.length > 0) menu.firstChild.click();
            }

            navegar(vistaId) {
                const area = document.getElementById('content-area'); area.innerHTML = '';
                switch(vistaId) {
                    case 'productos': Vistas.renderGestionProductos(area); break;
                    case 'usuarios': Vistas.renderUsuarios(area); break;
                    case 'historial': Vistas.renderHistorial(area); break;
                    case 'ventas': Vistas.renderNuevoPedido(area); break;
                    case 'clientes': Vistas.renderClientes(area); break;
                    case 'lista_pedidos': Vistas.renderListaPedidos(area); break;
                    case 'catalogo': Vistas.renderCatalogoVenta(area); break;
                    case 'almacen_stock': Vistas.renderAlmacenStock(area); break;
                    case 'viajes': Vistas.renderViajes(area); break;
                    default: area.innerHTML = '<p>En construcción</p>';
                }
            }
        }
        const sistema = new SistemaController();

        /** MÓDULO 4: VISTAS */
        const Vistas = {
            
            // --- NUEVO PEDIDO COMPLEJO ---
            carritoTemp: [],
            editCarritoTemp: [], // Variable temporal para editar productos de pedido
            
            renderNuevoPedido: (container) => {
                if (!Vistas.carritoTemp) Vistas.carritoTemp = [];
                container.innerHTML = `
                    <div class="grid-2">
                        <div class="card">
                            <h3 class="mb-2">1. Productos</h3>
                            <input type="text" id="bus-live" placeholder="Buscar producto..." oninput="Vistas.buscarLive()">
                            <div id="live-results" class="mb-4" style="max-height: 250px; overflow-y: auto;"></div>
                        </div>
                        <div class="card">
                            <h3 class="mb-2">2. Carrito</h3>
                            <div id="cart-list" class="mb-4" style="min-height:100px;">Vacío</div>
                            <div class="flex justify-between items-center border-t pt-2">
                                <h2 id="cart-total">S/ 0</h2>
                                <div>
                                    <button class="btn btn-secondary btn-sm" onclick="Vistas.limpiarCarrito()">Limpiar</button>
                                    <button class="btn btn-primary" onclick="Vistas.pasoFinalPedido()">Continuar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                if(Vistas.carritoTemp.length > 0) Vistas.renderCart();
            },

            buscarLive: () => {
                const q = document.getElementById('bus-live').value.toLowerCase();
                const div = document.getElementById('live-results'); div.innerHTML = '';
                if(q.length === 0) return;
                const encontrados = db.getTabla('productos').filter(p => p.estado === 'Activo' && (p.imei.toLowerCase().includes(q) || p.nombre.toLowerCase().includes(q)));
                if(encontrados.length === 0) div.innerHTML = '<p>Sin coincidencias</p>';
                encontrados.forEach(p => {
                    const tallas = Utils.obtenerTallasPorTipo(p.tipoTalla);
                    let btns = '';
                    tallas.forEach(t => {
                        const s = db.calcularStockVenta(p.imei, t);
                        const dis = s === 0 ? 'disabled style="opacity:0.5"' : '';
                        const color = s > 0 ? 'btn-success' : 'btn-secondary';
                        btns += `<button class="btn btn-sm ${color} m-2" ${dis} onclick="Vistas.addCart('${p.imei}','${t}',${p.precioRef})">${t} (${s})</button>`;
                    });
                    div.innerHTML += `<div class="search-result-item"><b>${p.nombre}</b> (${p.imei})<div>${btns}</div></div>`;
                });
            },

            addCart: (imei, talla, precio) => {
                const p = db.getTabla('productos').find(x => x.imei === imei);
                Vistas.carritoTemp.push({ id: Date.now(), imei, nombre: p.nombre, talla, cantidad: 1, precio, genero: 'Dama', entalle: '' });
                Vistas.renderCart();
            },

            renderCart: () => {
                const div = document.getElementById('cart-list'); div.innerHTML = '';
                let total = 0;
                Vistas.carritoTemp.forEach((it, idx) => {
                    total += (it.cantidad * it.precio);
                    div.innerHTML += `
                        <div class="p-2 border rounded mb-2 bg-gray-50">
                            <div class="flex justify-between"><b>${it.nombre} (${it.talla})</b> <button class="text-red-500 font-bold" onclick="Vistas.delCart(${idx})">×</button></div>
                            <div class="flex gap-2 mt-1">
                                <input type="number" value="${it.cantidad}" style="width:50px" onchange="Vistas.updCart(${idx},'cantidad',this.value)">
                                <input type="number" value="${it.precio}" style="width:70px" onchange="Vistas.updCart(${idx},'precio',this.value)">
                                <select onchange="Vistas.updCart(${idx},'genero',this.value)"><option>Dama</option><option>Caballero</option></select>
                            </div>
                            <input type="text" placeholder="Entalle..." value="${it.entalle}" onchange="Vistas.updCart(${idx},'entalle',this.value)" style="font-size:0.8rem; margin:0;">
                        </div>`;
                });
                document.getElementById('cart-total').innerText = `S/ ${total}`;
            },

            updCart: (idx, f, v) => {
                if(f === 'cantidad') {
                    const s = db.calcularStockVenta(Vistas.carritoTemp[idx].imei, Vistas.carritoTemp[idx].talla);
                    if(parseInt(v) > s) { alert(`Solo quedan ${s}`); Vistas.renderCart(); return; }
                }
                Vistas.carritoTemp[idx][f] = v; Vistas.renderCart();
            },
            delCart: (idx) => { Vistas.carritoTemp.splice(idx, 1); Vistas.renderCart(); },
            limpiarCarrito: () => { if(confirm('¿Borrar?')) { Vistas.carritoTemp = []; Vistas.renderCart(); } },

            pasoFinalPedido: () => {
                if(Vistas.carritoTemp.length === 0) return alert("Carrito vacío");
                
                // Generar opciones de vendedoras
                const vendedoras = db.getTabla('usuarios').filter(u => u.rol === 'vendedora');
                const optionsVend = vendedoras.map(v => `<option value="${v.nombre}">${v.nombre}</option>`).join('');

                const html = `
                    <h3>Completar Pedido</h3>
                    <div class="grid-2">
                        <!-- COL 1: CLIENTE Y ENTREGA -->
                        <div class="card">
                            <h4>Cliente</h4>
                            <div style="position:relative;">
                                <label>Teléfono (Busca auto.)</label>
                                <input type="text" id="info-tel" onkeyup="Vistas.buscarClienteInput()" autocomplete="off">
                                <div id="lista-clientes-sug" class="autocomplete-list hidden"></div>
                            </div>
                            <button id="btn-reg-cli" class="btn btn-sm btn-primary w-full hidden mb-2" onclick="Vistas.modalQuickCliente()">+ Registrar Cliente Nuevo</button>
                            <input type="text" id="info-nom" placeholder="Nombre Cliente" readonly>
                            
                            <h4 class="mt-4">Entrega</h4>
                            <div class="grid-2">
                                <div><label>Fecha</label><input type="date" id="info-fecha" value="${Utils.fechaHoy()}"></div>
                                <div><label>Tipo Pedido</label>
                                    <select id="info-tipo" onchange="Vistas.toggleEnvioUI()">
                                        <option value="Envio">Envío</option><option value="Visita">Visita</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="ui-envio">
                                <label>Método Entrega</label>
                                <select id="info-metodo"><option>A Domicilio</option><option>Agencia</option></select>
                                <label>Empresa</label>
                                <select id="info-empresa"><option>Olva</option><option>Shalom</option><option>Otros</option></select>
                                <label>Ciudad</label><input type="text" id="info-ciudad">
                            </div>
                            
                            <label>Dirección</label><input type="text" id="info-dir">
                            <label>URL Maps</label><input type="text" id="info-maps">
                            <label>Costo Envío (S/)</label><input type="number" id="info-envio" value="0" onchange="Vistas.calcTotalFinal()">
                        </div>

                        <!-- COL 2: PAGO Y OTROS -->
                        <div class="card">
                            <h4>Detalles Venta</h4>
                            <label>Vendedora Principal</label>
                            <input type="text" value="${sistema.usuarioActual.nombre}" disabled style="background:#eee">
                            
                            <label>Vendedora Contribuyó (Opcional)</label>
                            <select id="info-vend2"><option value="">-- Ninguna --</option>${optionsVend}</select>
                            
                            <label>Canal Venta</label>
                            <select id="info-canal">
                                <option value="Whatsapp" selected>Whatsapp</option><option>Facebook</option>
                                <option>Instagram</option><option>Tiktok</option><option>Teléfono</option><option>Otro</option>
                            </select>

                            <h4 class="mt-4">Pago</h4>
                            <label>Método Pago</label>
                            <select id="info-pago">
                                <option>YAPE</option><option>PLIN</option><option>BCP</option><option>BBVA</option>
                                <option>INTERBANK</option><option>SCOTIABANK</option><option>Banco Nación</option>
                                <option>Efectivo</option><option>Tarjeta</option>
                            </select>
                            
                            <div class="grid-2">
                                <div><label>Partes a Pagar</label><input type="number" id="info-partes" value="1" onchange="Vistas.togglePagos()"></div>
                                <div id="ui-primer-pago" class="hidden"><label>1er Pago</label><input type="number" id="info-monto1"></div>
                            </div>
                            
                            <div class="mt-4 p-2 bg-gray-100 rounded text-right">
                                <h2 id="display-total-final">Total: S/ 0</h2>
                            </div>

                            <button class="btn btn-success w-full mt-4" onclick="Vistas.guardarPedidoFull()">GUARDAR PEDIDO</button>
                            <button class="btn btn-secondary w-full mt-2" onclick="sistema.navegar('ventas')">Volver</button>
                        </div>
                    </div>
                `;
                document.getElementById('content-area').innerHTML = html;
                Vistas.calcTotalFinal();
            },

            toggleEnvioUI: () => {
                const tipo = document.getElementById('info-tipo').value;
                const div = document.getElementById('ui-envio');
                if (tipo === 'Visita') {
                    div.innerHTML = `<label>Lugar</label><select id="info-metodo"><option>A Domicilio</option><option>Local Peri</option></select>
                                     <label>Empresa</label><input id="info-empresa" value="Motorizado" disabled>`;
                    document.getElementById('info-ciudad').value = 'Lima';
                    document.getElementById('info-ciudad').parentElement.classList.add('hidden');
                } else {
                    div.innerHTML = `<label>Método Entrega</label><select id="info-metodo"><option>A Domicilio</option><option>Agencia</option></select>
                                     <label>Empresa</label><select id="info-empresa"><option>Olva</option><option>Shalom</option><option>Otros</option></select>
                                     <label>Ciudad</label><input type="text" id="info-ciudad">`;
                }
            },
            togglePagos: () => {
                const p = parseInt(document.getElementById('info-partes').value);
                if(p > 1) document.getElementById('ui-primer-pago').classList.remove('hidden');
                else document.getElementById('ui-primer-pago').classList.add('hidden');
            },
            calcTotalFinal: () => {
                const prod = Vistas.carritoTemp.reduce((a,b)=>a+(b.cantidad*b.precio),0);
                const env = parseFloat(document.getElementById('info-envio').value||0);
                document.getElementById('display-total-final').innerText = `Total: S/ ${prod+env}`;
            },

            // --- AUTOCOMPLETE CLIENTE ---
            buscarClienteInput: () => {
                const val = document.getElementById('info-tel').value;
                const list = document.getElementById('lista-clientes-sug');
                const btn = document.getElementById('btn-reg-cli');
                list.innerHTML = '';
                
                if(val.length < 3) { list.classList.add('hidden'); return; }
                
                const matches = db.getTabla('clientes').filter(c => c.telefono.includes(val));
                
                if(matches.length === 0) {
                    list.classList.add('hidden');
                    btn.classList.remove('hidden'); // Mostrar boton registrar
                } else {
                    btn.classList.add('hidden');
                    list.classList.remove('hidden');
                    matches.forEach(c => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.innerText = `${c.telefono} - ${c.nombre}`;
                        item.onclick = () => {
                            document.getElementById('info-tel').value = c.telefono;
                            document.getElementById('info-nom').value = c.nombre;
                            document.getElementById('info-dir').value = c.direccion;
                            list.classList.add('hidden');
                        };
                        list.appendChild(item);
                    });
                }
            },
            modalQuickCliente: () => {
                const tel = document.getElementById('info-tel').value;
                const html = `<h3>Nuevo Cliente Rápido</h3>
                    <input type="text" id="q-tel" value="${tel}">
                    <input type="text" id="q-nom" placeholder="Nombre">
                    <input type="text" id="q-dir" placeholder="Dirección">
                    <button class="btn btn-success w-full" onclick="Vistas.saveQuickCliente()">Guardar</button>
                    <button class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cancelar</button>`;
                Vistas.abrirModal(html);
            },
            saveQuickCliente: () => {
                const t = document.getElementById('q-tel').value;
                const n = document.getElementById('q-nom').value;
                const d = document.getElementById('q-dir').value;
                if(!t || !n) return alert("Falta info");
                db.insertar('clientes', new Cliente(t,n,'F',d));
                document.getElementById('info-tel').value = t;
                document.getElementById('info-nom').value = n;
                document.getElementById('info-dir').value = d;
                document.getElementById('btn-reg-cli').classList.add('hidden');
                Vistas.cerrarModal();
            },

            guardarPedidoFull: () => {
                const info = {
                    tel: document.getElementById('info-tel').value,
                    nom: document.getElementById('info-nom').value,
                    fecha: document.getElementById('info-fecha').value,
                    tipo: document.getElementById('info-tipo').value,
                    metodoEnt: document.getElementById('info-metodo').value,
                    empresa: document.getElementById('info-empresa').value || 'Motorizado',
                    ciudad: document.getElementById('info-ciudad')?.value || 'Lima',
                    dir: document.getElementById('info-dir').value,
                    maps: document.getElementById('info-maps').value,
                    envioCosto: document.getElementById('info-envio').value,
                    vend1: sistema.usuarioActual.nombre,
                    vend2: document.getElementById('info-vend2').value,
                    canal: document.getElementById('info-canal').value,
                    pagoMetodo: document.getElementById('info-pago').value,
                    partes: document.getElementById('info-partes').value,
                    pago1: document.getElementById('info-monto1')?.value || 0
                };
                
                if(!info.tel || !info.nom) return alert("Faltan datos cliente");

                const codigo = Utils.generarCodigoPedido();
                const pedido = new Pedido(codigo, info, Vistas.carritoTemp);
                
                db.insertar('pedidos', pedido);
                db.insertar('historial', new HistorialCambio('Pedido', codigo, sistema.usuarioActual.username, 'Crear', 'Pedido Completo'));
                
                alert("Pedido creado: " + codigo);
                Vistas.carritoTemp = [];
                sistema.navegar('lista_pedidos');
            },

            // --- VIAJES Y PICKING (ALMACEN) ---
            renderViajes: (container) => {
                container.innerHTML = `<h2>Viajes y Despacho</h2>
                    <div class="table-container"><table><thead><tr><th>Fecha</th><th>Pedido</th><th>Tipo</th><th>Estado</th><th>Acción</th></tr></thead><tbody id="lista-viajes"></tbody></table></div>`;
                const tbody = document.getElementById('lista-viajes');
                // Mostrar viajes ordenados
                const viajes = db.getTabla('viajes').sort((a,b) => b.fecha.localeCompare(a.fecha));
                
                viajes.forEach(v => {
                    let btnAccion = '';
                    if(v.estado === 'Pendiente') btnAccion = `<button class="btn btn-sm btn-primary" onclick="Vistas.modalAlistarViaje('${v.id}')">Alistar (Picking)</button>`;
                    else if(v.estado === 'Alistado') btnAccion = `<span class="text-green-600 bold">Listo para Salir</span>`;
                    
                    tbody.innerHTML += `<tr>
                        <td>${v.fecha}</td>
                        <td>${v.idPedido}</td>
                        <td>${v.tipo}</td>
                        <td><span class="badge badge-${v.estado.toLowerCase()}">${v.estado}</span></td>
                        <td>${btnAccion}</td>
                    </tr>`;
                });
            },

            modalAlistarViaje: (idViaje) => {
                const viaje = db.getTabla('viajes').find(v => v.id == idViaje); 
                const pedido = db.getTabla('pedidos').find(p => p.codigo === viaje.idPedido);
                
                let html = `<h3>Alistar Pedido: ${pedido.codigo}</h3><p class="mb-2 text-sm text-gray-500">Asigna productos físicos por cantidad.</p>`;
                
                let todoCompleto = true;

                pedido.productos.forEach((prod, idx) => {
                    const asignados = db.getTabla('productosFisicos').filter(pf => 
                        pf.idPedidoAsignado === pedido.codigo && 
                        pf.imei === prod.imei && 
                        pf.talla === prod.talla
                    );
                    
                    const cantidadNecesaria = parseInt(prod.cantidad);
                    const cantidadAsignada = asignados.length;
                    const completado = cantidadAsignada >= cantidadNecesaria;
                    
                    if(!completado) todoCompleto = false;

                    const colorBorder = completado ? 'green' : '#ccc';
                    const statusText = completado ? '<span class="text-green-600 bold">COMPLETO</span>' : `<span class="text-red-500 bold">${cantidadAsignada} / ${cantidadNecesaria}</span>`;
                    
                    // Renderizar lista de asignados
                    let listaAsignadosHtml = '';
                    if(asignados.length > 0) {
                        listaAsignadosHtml = `<div class="mt-2 text-xs text-gray-600">IDs: ${asignados.map(a => `<b>${a.id}</b>`).join(', ')}</div>`;
                    }

                    // Input de búsqueda solo si falta
                    let inputHtml = '';
                    if(!completado) {
                        inputHtml = `
                            <div class="mt-2" style="position:relative;">
                                <input type="text" placeholder="Escribir ID Físico..." 
                                    onkeyup="Vistas.buscarFisicoPicking(this, '${prod.imei}', '${prod.talla}', '${viaje.id}')"
                                    class="mb-0">
                                <div class="autocomplete-list hidden"></div>
                            </div>
                        `;
                    }

                    html += `
                        <div class="card mb-2" style="border-left: 4px solid ${colorBorder}; padding: 1rem;">
                            <div class="flex justify-between">
                                <b>${prod.nombre} (${prod.talla})</b>
                                ${statusText}
                            </div>
                            <div class="text-sm text-gray-500">IMEI: ${prod.imei}</div>
                            ${listaAsignadosHtml}
                            ${inputHtml}
                        </div>
                    `;
                });

                if (!todoCompleto) {
                    html += `<div class="p-2 bg-yellow-100 text-yellow-800 text-sm mt-4 rounded text-center">Falta asignar productos para finalizar.</div>`;
                }
                
                html += `<button class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cerrar (Guardar Progreso)</button>`;
                
                Vistas.abrirModal(html);
            },

            buscarFisicoPicking: (input, imei, talla, idViaje) => {
                const val = input.value.toUpperCase();
                const list = input.nextElementSibling;
                list.innerHTML = '';
                
                if(val.length < 1) { list.classList.add('hidden'); return; }
                
                // Buscar disponibles que coincidan
                const matches = db.getTabla('productosFisicos').filter(pf => 
                    pf.estado === 'DISPONIBLE' && 
                    pf.imei === imei && 
                    pf.talla === talla && 
                    pf.id.includes(val)
                );

                if(matches.length === 0) {
                    list.classList.add('hidden');
                } else {
                    list.classList.remove('hidden');
                    matches.forEach(pf => {
                        const item = document.createElement('div');
                        item.className = 'autocomplete-item';
                        item.innerText = `ID: ${pf.id}`;
                        item.onclick = () => Vistas.asignarFisico(pf.id, idViaje);
                        list.appendChild(item);
                    });
                }
            },

            asignarFisico: (idFisico, idViaje) => {
                const viaje = db.getTabla('viajes').find(v => v.id == idViaje);
                
                // 1. Asignar el producto físico
                db.actualizar('productosFisicos', 'id', idFisico, { 
                    estado: 'ASIGNADO', 
                    idPedidoAsignado: viaje.idPedido 
                });
                
                // 2. Verificar si el Viaje está COMPLETAMENTE alistado
                const pedido = db.getTabla('pedidos').find(p => p.codigo === viaje.idPedido);
                let isTripComplete = true;
                
                pedido.productos.forEach(prod => {
                    const asignados = db.getTabla('productosFisicos').filter(pf => 
                        pf.idPedidoAsignado === pedido.codigo && 
                        pf.imei === prod.imei && 
                        pf.talla === prod.talla
                    );
                    if (asignados.length < parseInt(prod.cantidad)) {
                        isTripComplete = false;
                    }
                });

                if (isTripComplete) {
                    // a) Actualizar estado del Viaje
                    db.actualizar('viajes', 'id', parseInt(idViaje), { estado: 'Alistado' });
                    alert("¡Picking completado! El viaje ha pasado a estado 'Alistado'.");

                    // b) Verificar si el PEDIDO completo está alistado (todos sus viajes listos)
                    const viajesDelPedido = db.getTabla('viajes').filter(v => v.idPedido === pedido.codigo && v.estado !== 'Cancelado');
                    const todosAlistados = viajesDelPedido.every(v => v.estado === 'Alistado' || v.estado === 'Realizado'); 
                    
                    if (todosAlistados) {
                        db.actualizar('pedidos', 'codigo', pedido.codigo, { estado: 'Alistado' });
                        alert("¡Todos los viajes listos! El pedido ahora está 'Alistado'.");
                    }
                    
                    Vistas.cerrarModal();
                    sistema.navegar('viajes');
                } else {
                    // Si no está completo, simplemente recargar el modal para seguir escaneando
                    Vistas.modalAlistarViaje(idViaje);
                }
            },

            // --- LISTA PEDIDOS Y CAMBIO ESTADO (Con edición) ---
            renderListaPedidos: (container) => {
                container.innerHTML = `<h2>Pedidos</h2><div class="table-container"><table><thead><tr><th>Cód</th><th>Estado</th><th>Cliente</th><th>Entrega</th><th>Acciones</th></tr></thead><tbody id="tb-ped"></tbody></table></div>`;
                db.getTabla('pedidos').reverse().forEach(p => {
                    const badge = `badge-${p.estado.toLowerCase()}`;
                    let botonesEdicion = '';
                    
                    // Lógica para botones de editar: solo si es Solicitado o Efectivo
                    if (p.estado === 'Solicitado' || p.estado === 'Efectivo') {
                        botonesEdicion = `
                            <button class="btn btn-sm btn-secondary" onclick="Vistas.modalEditarInfoPedido('${p.codigo}')">Info</button>
                            <button class="btn btn-sm btn-warning" onclick="Vistas.modalEditarProductosPedido('${p.codigo}')">Prods</button>
                        `;
                    }

                    document.getElementById('tb-ped').innerHTML += `<tr>
                        <td><b>${p.codigo}</b></td>
                        <td><span class="badge ${badge}">${p.estado}</span></td>
                        <td>${p.info.tel}<br><small>${p.info.nom}</small></td>
                        <td>${p.info.fecha}<br><small>${p.info.tipo}</small></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="Vistas.modalEstadoPedido('${p.codigo}')">Estado</button>
                            ${botonesEdicion}
                        </td>
                    </tr>`;
                });
            },

            // --- EDICIÓN INFORMACIÓN PEDIDO ---
            modalEditarInfoPedido: (cod) => {
                const p = db.getTabla('pedidos').find(x => x.codigo === cod);
                const vendedoras = db.getTabla('usuarios').filter(u => u.rol === 'vendedora');
                const optionsVend = vendedoras.map(v => `<option value="${v.nombre}" ${p.info.vend2===v.nombre?'selected':''}>${v.nombre}</option>`).join('');
                
                const html = `
                    <h3>Editar Información: ${cod}</h3>
                    <div class="grid-2">
                        <div>
                            <label>Fecha</label><input type="date" id="ei-fecha" value="${p.info.fecha}">
                            <label>Teléfono</label><input type="text" id="ei-tel" value="${p.info.tel}">
                            <label>Nombre</label><input type="text" id="ei-nom" value="${p.info.nom}">
                            <label>Dirección</label><input type="text" id="ei-dir" value="${p.info.dir}">
                            <label>Ciudad</label><input type="text" id="ei-ciudad" value="${p.info.ciudad}">
                            <label>Empresa</label><select id="ei-empresa">
                                <option ${p.info.empresa=='Olva'?'selected':''}>Olva</option>
                                <option ${p.info.empresa=='Shalom'?'selected':''}>Shalom</option>
                                <option ${p.info.empresa=='Motorizado'?'selected':''}>Motorizado</option>
                                <option ${p.info.empresa=='Otros'?'selected':''}>Otros</option>
                            </select>
                        </div>
                        <div>
                            <label>Método Pago</label><select id="ei-pago">
                                <option ${p.info.pagoMetodo=='YAPE'?'selected':''}>YAPE</option>
                                <option ${p.info.pagoMetodo=='PLIN'?'selected':''}>PLIN</option>
                                <option ${p.info.pagoMetodo=='BCP'?'selected':''}>BCP</option>
                                <option ${p.info.pagoMetodo=='Efectivo'?'selected':''}>Efectivo</option>
                                <option ${p.info.pagoMetodo=='Tarjeta'?'selected':''}>Tarjeta</option>
                            </select>
                            <label>Vendedora Apoyo</label><select id="ei-vend2"><option value="">--</option>${optionsVend}</select>
                            <label>Costo Envío</label><input type="number" id="ei-envio" value="${p.info.envioCosto}">
                            <label>URL Maps</label><input type="text" id="ei-maps" value="${p.info.maps}">
                        </div>
                    </div>
                    <button class="btn btn-success w-full mt-4" onclick="Vistas.guardarEdicionInfoPedido('${cod}')">Guardar Cambios</button>
                    <button class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cancelar</button>
                `;
                Vistas.abrirModal(html);
            },

            guardarEdicionInfoPedido: (cod) => {
                const pedido = db.getTabla('pedidos').find(x => x.codigo === cod);
                
                const nuevosDatos = {
                    ...pedido.info,
                    fecha: document.getElementById('ei-fecha').value,
                    tel: document.getElementById('ei-tel').value,
                    nom: document.getElementById('ei-nom').value,
                    dir: document.getElementById('ei-dir').value,
                    ciudad: document.getElementById('ei-ciudad').value,
                    empresa: document.getElementById('ei-empresa').value,
                    pagoMetodo: document.getElementById('ei-pago').value,
                    vend2: document.getElementById('ei-vend2').value,
                    envioCosto: document.getElementById('ei-envio').value,
                    maps: document.getElementById('ei-maps').value
                };

                db.actualizar('pedidos', 'codigo', cod, { info: nuevosDatos });
                db.insertar('historial', new HistorialCambio('Pedido', cod, sistema.usuarioActual.username, 'Editar Info', 'Actualización datos cliente/entrega'));
                
                alert('Información actualizada');
                Vistas.cerrarModal();
                sistema.navegar('lista_pedidos');
            },

            // --- EDICIÓN PRODUCTOS PEDIDO ---
            modalEditarProductosPedido: (cod) => {
                const p = db.getTabla('pedidos').find(x => x.codigo === cod);
                // Clonar productos para no editar referencia directa hasta guardar
                Vistas.editCarritoTemp = JSON.parse(JSON.stringify(p.productos));
                
                const html = `
                    <h3>Editar Productos: ${cod}</h3>
                    <div class="grid-2">
                        <div class="card">
                            <h4 class="mb-2">Agregar Producto</h4>
                            <input type="text" id="edit-bus-live" placeholder="Buscar..." oninput="Vistas.buscarEditLive()">
                            <div id="edit-live-results" class="mb-4" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        <div class="card">
                            <h4 class="mb-2">Productos en Pedido</h4>
                            <div id="edit-cart-list"></div>
                            <div class="border-t pt-2 mt-2 text-right">
                                <h3 id="edit-cart-total"></h3>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success w-full mt-4" onclick="Vistas.guardarEdicionProductosPedido('${cod}')">Guardar Cambios de Productos</button>
                    <button class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cancelar</button>
                `;
                Vistas.abrirModal(html);
                Vistas.renderEditCart();
            },

            buscarEditLive: () => {
                const q = document.getElementById('edit-bus-live').value.toLowerCase();
                const div = document.getElementById('edit-live-results'); div.innerHTML = '';
                if(q.length === 0) return;
                
                const encontrados = db.getTabla('productos').filter(p => p.estado === 'Activo' && (p.imei.toLowerCase().includes(q) || p.nombre.toLowerCase().includes(q)));
                
                encontrados.forEach(p => {
                    const tallas = Utils.obtenerTallasPorTipo(p.tipoTalla);
                    let btns = '';
                    tallas.forEach(t => {
                        const s = db.calcularStockVenta(p.imei, t);
                        // Permitir agregar aunque stock sea 0 si es admin/vendedora (flexibilidad al editar), 
                        // o mantener logica estricta. Mantendremos logica de stock visual.
                        const color = s > 0 ? 'btn-success' : 'btn-secondary';
                        btns += `<button class="btn btn-sm ${color} m-1" onclick="Vistas.addEditCart('${p.imei}','${t}',${p.precioRef})">${t} (${s})</button>`;
                    });
                    div.innerHTML += `<div class="search-result-item p-2 text-sm"><b>${p.nombre}</b><div>${btns}</div></div>`;
                });
            },

            addEditCart: (imei, talla, precio) => {
                const p = db.getTabla('productos').find(x => x.imei === imei);
                Vistas.editCarritoTemp.push({ id: Date.now(), imei, nombre: p.nombre, talla, cantidad: 1, precio, genero: 'Dama', entalle: '' });
                Vistas.renderEditCart();
            },

            renderEditCart: () => {
                const div = document.getElementById('edit-cart-list'); 
                if(!div) return;
                div.innerHTML = '';
                let total = 0;
                
                Vistas.editCarritoTemp.forEach((it, idx) => {
                    total += (it.cantidad * it.precio);
                    div.innerHTML += `
                        <div class="p-2 border rounded mb-2 bg-gray-50 text-sm">
                            <div class="flex justify-between">
                                <b>${it.nombre} (${it.talla})</b> 
                                <button class="text-red-500 font-bold" onclick="Vistas.delEditCart(${idx})">×</button>
                            </div>
                            <div class="flex gap-2 mt-1">
                                <input type="number" value="${it.cantidad}" style="width:50px" onchange="Vistas.updEditCart(${idx},'cantidad',this.value)">
                                <input type="number" value="${it.precio}" style="width:70px" onchange="Vistas.updEditCart(${idx},'precio',this.value)">
                            </div>
                        </div>`;
                });
                document.getElementById('edit-cart-total').innerText = `Total Productos: S/ ${total}`;
            },

            updEditCart: (idx, f, v) => {
                if(f === 'cantidad') {
                    // Validar stock si se quiere, pero al editar a veces se fuerza.
                    // Dejaremos libre edición, el sistema descontará de stock disponible al guardar.
                }
                Vistas.editCarritoTemp[idx][f] = v; 
                Vistas.renderEditCart();
            },

            delEditCart: (idx) => {
                Vistas.editCarritoTemp.splice(idx, 1);
                Vistas.renderEditCart();
            },

            guardarEdicionProductosPedido: (cod) => {
                if(Vistas.editCarritoTemp.length === 0) return alert("El pedido no puede quedar vacío");
                
                db.actualizar('pedidos', 'codigo', cod, { productos: Vistas.editCarritoTemp });
                db.insertar('historial', new HistorialCambio('Pedido', cod, sistema.usuarioActual.username, 'Editar Productos', 'Modificación items del pedido'));
                
                alert('Productos actualizados');
                Vistas.cerrarModal();
                sistema.navegar('lista_pedidos');
            },

            modalEstadoPedido: (cod) => {
                const p = db.getTabla('pedidos').find(x => x.codigo === cod);
                const html = `
                    <h3>Cambiar Estado: ${cod}</h3>
                    <p>Estado Actual: <b>${p.estado}</b></p>
                    <div class="flex flex-col gap-2">
                        ${p.estado === 'Solicitado' ? `<button class="btn btn-success" onclick="Vistas.setEstado('${cod}','Efectivo')">Marcar como EFECTIVO (Crear Viaje)</button>` : ''}
                        ${p.estado === 'Alistado' ? `<button class="btn btn-primary" onclick="Vistas.setEstado('${cod}','Enviado')">Marcar como ENVIADO</button>` : ''}
                        <button class="btn btn-danger" onclick="Vistas.setEstado('${cod}','Cancelado')">Cancelar Pedido</button>
                    </div>
                    <button class="btn btn-secondary w-full mt-4" onclick="Vistas.cerrarModal()">Cerrar</button>
                `;
                Vistas.abrirModal(html);
            },

            setEstado: (cod, nuevo) => {
                const p = db.getTabla('pedidos').find(x => x.codigo === cod);
                
                if (nuevo === 'Efectivo') {
                    // Crear viaje automatico
                    db.insertar('viajes', new Viaje(Date.now(), cod, 'Entrega', p.info.fecha));
                    alert("Viaje de entrega creado automáticamente.");
                }

                db.actualizar('pedidos', 'codigo', cod, { estado: nuevo });
                
                // Si se cancela, cancelar viaje tambien
                if (nuevo === 'Cancelado') {
                    const v = db.getTabla('viajes').find(x => x.idPedido === cod && x.tipo === 'Entrega');
                    if(v) db.actualizar('viajes', 'id', v.id, { estado: 'Cancelado' });
                    db.getTabla('productosFisicos').forEach(pf => {
                        if(pf.idPedidoAsignado === cod) {
                            db.actualizar('productosFisicos', 'id', pf.id, { estado: 'DISPONIBLE', idPedidoAsignado: null });
                        }
                    });
                }

                Vistas.cerrarModal();
                sistema.navegar('lista_pedidos');
            },

            // --- GESTIÓN PRODUCTOS (Lógica Restaurada Completa) ---
            renderGestionProductos: (container) => {
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2>Gestión de Productos</h2>
                        <button class="btn btn-primary" onclick="Vistas.modalCrearProducto()">+ Nuevo Producto</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>IMEI</th><th>Nombre</th><th>Tallas</th><th>Precio Ref</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody id="body-prod-admin"></tbody>
                        </table>
                    </div>
                `;
                const tbody = document.getElementById('body-prod-admin');
                db.getTabla('productos').forEach(p => {
                    if(p.estado === 'Eliminado') return;
                    tbody.innerHTML += `<tr>
                        <td>${p.imei}</td>
                        <td>${p.nombre}</td>
                        <td>${p.tipoTalla}</td>
                        <td>S/ ${p.precioRef}</td>
                        <td><span class="badge" style="background:${p.estado=='Activo'?'#dcfce7':'#fee2e2'}">${p.estado}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="Vistas.modalEditarProducto('${p.imei}')">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="Vistas.eliminarProducto('${p.imei}')">X</button>
                        </td>
                    </tr>`;
                });
            },

            modalCrearProducto: () => {
                 const html = `
                    <h3>Registrar Producto</h3>
                    <form onsubmit="event.preventDefault(); Vistas.guardarProductoNuevo()">
                        <input type="text" id="p-imei" placeholder="IMEI" required>
                        <input type="text" id="p-nom" placeholder="Nombre" required>
                        <select id="p-talla" required>
                            <option value="">-- Seleccionar Tipo Talla --</option>
                            <option value="A">Tipo A (XS-XXL)</option>
                            <option value="B">Tipo B (26-36)</option>
                            <option value="C">Tipo C (2-16)</option>
                            <option value="Sin Talla">Sin Talla</option>
                        </select>
                        <input type="number" id="p-precio" placeholder="Precio Ref" value="99">
                        <button class="btn btn-success w-full mt-4">Guardar</button>
                        <button type="button" class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cancelar</button>
                    </form>
                `;
                Vistas.abrirModal(html);
            },

            guardarProductoNuevo: () => {
                const imei = document.getElementById('p-imei').value;
                if(db.getTabla('productos').find(p => p.imei === imei && p.estado !== 'Eliminado')) return alert("IMEI Duplicado");

                const prod = new Producto(
                    Utils.generarId(),
                    imei,
                    document.getElementById('p-nom').value,
                    '',
                    document.getElementById('p-talla').value,
                    document.getElementById('p-precio').value
                );
                db.insertar('productos', prod);
                db.insertar('historial', new HistorialCambio('Producto', imei, sistema.usuarioActual.username, 'Crear', 'Nuevo producto'));
                Vistas.cerrarModal();
                sistema.navegar('productos');
            },

            modalEditarProducto: (imei) => {
                const p = db.getTabla('productos').find(x => x.imei === imei);
                let opcionesTalla = `<option value="${p.tipoTalla}" selected>${p.tipoTalla} (Actual)</option>`;
                
                if(p.tipoTalla === 'A') opcionesTalla += `<option value="A + C">A + C (Agregar tallas C)</option>`;
                if(p.tipoTalla === 'B') opcionesTalla += `<option value="B + C">B + C (Agregar tallas C)</option>`;

                const html = `
                    <h3>Editar: ${p.nombre}</h3>
                    <form onsubmit="event.preventDefault(); Vistas.guardarEdicionProducto('${imei}')">
                        <label>IMEI</label><input type="text" id="e-imei" value="${p.imei}">
                        <label>Nombre</label><input type="text" id="e-nom" value="${p.nombre}">
                        <label>Precio Ref</label><input type="number" id="e-precio" value="${p.precioRef}">
                        <label>Talla</label><select id="e-talla">${opcionesTalla}</select>
                        <label>Estado</label>
                        <select id="e-est">
                            <option value="Activo" ${p.estado=='Activo'?'selected':''}>Activo</option>
                            <option value="Inactivo" ${p.estado=='Inactivo'?'selected':''}>Inactivo</option>
                        </select>
                        <button class="btn btn-primary w-full mt-4">Guardar</button>
                        <button type="button" class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cancelar</button>
                    </form>
                `;
                Vistas.abrirModal(html);
            },

            guardarEdicionProducto: (imeiOriginal) => {
                const nuevoImei = document.getElementById('e-imei').value;
                if (nuevoImei !== imeiOriginal) {
                    if(!confirm(`¿Cambiar IMEI de ${imeiOriginal} a ${nuevoImei}?`)) return;
                    if(prompt("Confirma con DNI:") === null) return;
                }
                
                db.actualizar('productos', 'imei', imeiOriginal, {
                    imei: nuevoImei,
                    nombre: document.getElementById('e-nom').value,
                    precioRef: document.getElementById('e-precio').value,
                    tipoTalla: document.getElementById('e-talla').value,
                    estado: document.getElementById('e-est').value
                });
                Vistas.cerrarModal();
                sistema.navegar('productos');
            },

            eliminarProducto: (imei) => {
                if(confirm("¿Eliminar producto?")) {
                    db.actualizar('productos', 'imei', imei, { estado: 'Eliminado' });
                    sistema.navegar('productos');
                }
            },

            // --- USUARIOS, HISTORIAL, CLIENTES ---
            renderUsuarios: (container) => { 
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4"><h2>Usuarios</h2><button class="btn btn-primary" onclick="Vistas.modalCrearUsuario()">+ Usuario</button></div>
                    <div class="table-container"><table><thead><tr><th>User</th><th>Nombre</th><th>Rol</th><th>Accion</th></tr></thead><tbody id="tb-user"></tbody></table></div>`;
                const tbody = document.getElementById('tb-user');
                db.getTabla('usuarios').forEach(u => {
                    tbody.innerHTML += `<tr>
                        <td>${u.username}</td>
                        <td>${u.nombre}</td>
                        <td>${u.rol}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="Vistas.modalEditarUsuario(${u.id})">Editar</button>
                            ${u.id!==1?`<button class="btn btn-sm btn-danger" onclick="Vistas.eliminarUsuario(${u.id})">X</button>`:''}
                        </td>
                    </tr>`;
                });
            },
            modalCrearUsuario: () => {
                Vistas.abrirModal(`<h3>Nuevo Usuario</h3><input id="u-user" placeholder="User"><input id="u-pass" placeholder="Pass"><input id="u-name" placeholder="Nombre">
                <select id="u-rol"><option value="vendedora">Vendedora</option><option value="almacen">Almacen</option><option value="controller">Controller</option></select>
                <button class="btn btn-success w-full" onclick="Vistas.guardarUsuario()">Crear</button>`);
            },
            guardarUsuario: () => {
                db.insertar('usuarios', new Usuario(Date.now(), document.getElementById('u-user').value, document.getElementById('u-pass').value, document.getElementById('u-rol').value, document.getElementById('u-name').value));
                Vistas.cerrarModal(); sistema.navegar('usuarios');
            },
            eliminarUsuario: (id) => { if(confirm("¿Borrar usuario?")) { db.eliminar('usuarios', 'id', id); sistema.navegar('usuarios'); } },
            
            modalEditarUsuario: (id) => {
                const u = db.getTabla('usuarios').find(x => x.id === id);
                const roles = ['vendedora', 'almacen', 'controller'];
                const options = roles.map(r => `<option value="${r}" ${u.rol === r ? 'selected' : ''}>${r.charAt(0).toUpperCase() + r.slice(1)}</option>`).join('');

                const html = `
                    <h3>Editar Usuario</h3>
                    <label>Usuario</label><input id="e-u-user" value="${u.username}">
                    <label>Contraseña</label><input id="e-u-pass" value="${u.password}">
                    <label>Nombre</label><input id="e-u-name" value="${u.nombre}">
                    <label>Rol</label><select id="e-u-rol">${options}</select>
                    <button class="btn btn-primary w-full mt-4" onclick="Vistas.guardarEdicionUsuario(${id})">Guardar Cambios</button>
                    <button class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cancelar</button>
                `;
                Vistas.abrirModal(html);
            },
            
            guardarEdicionUsuario: (id) => {
                const updates = {
                    username: document.getElementById('e-u-user').value,
                    password: document.getElementById('e-u-pass').value,
                    nombre: document.getElementById('e-u-name').value,
                    rol: document.getElementById('e-u-rol').value
                };
                
                if(!updates.username || !updates.password) return alert("Usuario y contraseña requeridos");
                
                db.actualizar('usuarios', 'id', id, updates);
                Vistas.cerrarModal();
                sistema.navegar('usuarios');
            },

            renderHistorial: (c) => { 
                c.innerHTML = `<h2>Historial</h2><div class="table-container"><table><thead><tr><th>Fecha</th><th>Entidad</th><th>Detalle</th><th>User</th></tr></thead><tbody id="tb-hist"></tbody></table></div>`;
                db.getTabla('historial').reverse().slice(0,50).forEach(h => {
                   document.getElementById('tb-hist').innerHTML += `<tr><td>${h.fecha}</td><td>${h.entidad} (${h.accion})</td><td>${h.detalles}</td><td>${h.usuario}</td></tr>`; 
                });
            },

            renderClientes: (c) => { 
                c.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h2>Clientes</h2><button class="btn btn-primary" onclick="Vistas.modalCrearClienteFull()">+ Cliente</button></div>
                <div class="table-container"><table><thead><tr><th>Tel</th><th>Nombre</th><th>Dirección</th><th>Acción</th></tr></thead><tbody id="tb-cli"></tbody></table></div>`;
                db.getTabla('clientes').forEach(cli => {
                   document.getElementById('tb-cli').innerHTML += `<tr><td>${cli.telefono}</td><td>${cli.nombre}</td><td>${cli.direccion}</td><td><button class="btn btn-sm btn-secondary" onclick="Vistas.modalEditarCliente('${cli.telefono}')">Editar</button></td></tr>`;
                });
            },
            modalCrearClienteFull: () => {
                 Vistas.abrirModal(`<h3>Nuevo Cliente</h3><input id="new-cli-tel" placeholder="Tel"><input id="new-cli-nom" placeholder="Nom"><input id="new-cli-dir" placeholder="Dir"><button class="btn btn-success w-full" onclick="Vistas.saveClienteFull()">Guardar</button>`);
            },
            saveClienteFull: () => {
                db.insertar('clientes', new Cliente(document.getElementById('new-cli-tel').value, document.getElementById('new-cli-nom').value, 'F', document.getElementById('new-cli-dir').value));
                Vistas.cerrarModal(); sistema.navegar('clientes');
            },
            modalEditarCliente: (tel) => {
                const c = db.getTabla('clientes').find(x => x.telefono === tel);
                Vistas.abrirModal(`<h3>Editar Cliente</h3><input value="${c.telefono}" disabled><input id="ed-cli-nom" value="${c.nombre}"><input id="ed-cli-dir" value="${c.direccion}"><button class="btn btn-primary w-full" onclick="Vistas.saveEdCliente('${tel}')">Guardar</button>`);
            },
            saveEdCliente: (tel) => {
                db.actualizar('clientes', 'telefono', tel, { nombre: document.getElementById('ed-cli-nom').value, direccion: document.getElementById('ed-cli-dir').value });
                Vistas.cerrarModal(); sistema.navegar('clientes');
            },

            // --- CATALOGO STOCK CON PESTAÑAS ---
            renderCatalogoVenta: (c) => {
                c.innerHTML = `
                    <h2>Stock Global</h2>
                    <div class="sub-tabs mt-4">
                        <div class="sub-tab active" onclick="Vistas.switchTabCatalogo(this, 'ventas')">Vista Ventas</div>
                        <div class="sub-tab" onclick="Vistas.switchTabCatalogo(this, 'almacen')">Vista Almacén</div>
                    </div>
                    <div id="cat-content"></div>
                `;
                Vistas.renderCatalogoVentasContent();
            },

            switchTabCatalogo: (tab, view) => {
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                if (view === 'ventas') Vistas.renderCatalogoVentasContent();
                else Vistas.renderCatalogoAlmacenContent();
            },

            renderCatalogoVentasContent: () => {
                const div = document.getElementById('cat-content');
                div.innerHTML = '';
                db.getTabla('productos').forEach(p => {
                    if(p.estado !== 'Activo') return;
                    let badges = '';
                    Utils.obtenerTallasPorTipo(p.tipoTalla).forEach(t => {
                        const s = db.calcularStockVenta(p.imei, t);
                        if(s>0) badges += `<span class="badge badge-efectivo m-2">${t}: ${s}</span>`;
                    });
                    div.innerHTML += `<div class="card mb-2 flex justify-between"><div><b>${p.nombre}</b><br><small>${p.imei}</small></div><div>${badges||'<span class="text-red-500 text-sm">Sin Stock</span>'}</div></div>`;
                });
            },

            renderCatalogoAlmacenContent: () => {
                const div = document.getElementById('cat-content');
                div.innerHTML = '<p class="text-sm text-gray-500 mb-2">Productos físicos en almacén (No asignados).</p>';
                const disponibles = db.getTabla('productosFisicos').filter(pf => pf.estado === 'DISPONIBLE');
                
                if(disponibles.length === 0) {
                    div.innerHTML += '<div class="p-4 text-center">Almacén Vacío</div>';
                    return;
                }

                // Agrupar visualmente o lista simple
                const html = `<div class="table-container"><table><thead><tr><th>ID Físico</th><th>IMEI</th><th>Talla</th></tr></thead><tbody>
                    ${disponibles.map(pf => `<tr><td><b>${pf.id}</b></td><td>${pf.imei}</td><td>${pf.talla}</td></tr>`).join('')}
                </tbody></table></div>`;
                div.innerHTML += html;
            },

            // --- ALMACEN STOCK (Lógica Restaurada Completa con Buscador) ---
            renderAlmacenStock: (c) => { 
                c.innerHTML=`<div class="flex justify-between items-center mb-4"><h2>Stock Físico</h2><button class="btn btn-primary" onclick="Vistas.modalAddStock()">+ Ingreso</button></div>
                <div class="table-container"><table><thead><tr><th>ID (QR)</th><th>Producto</th><th>Talla</th><th>Estado</th></tr></thead><tbody id="tb-fis"></tbody></table></div>`;
                db.getTabla('productosFisicos').reverse().slice(0,100).forEach(pf => {
                    document.getElementById('tb-fis').innerHTML += `<tr><td>${pf.id}</td><td>${pf.imei}</td><td>${pf.talla}</td><td>${pf.estado}</td></tr>`;
                });
            },
            
            modalAddStock: () => {
                const html = `
                    <h3>Ingreso Almacén</h3>
                    <p class="text-sm mb-2">Busca el producto para registrar stock:</p>
                    <input type="text" id="stock-search" placeholder="Escribe nombre o IMEI..." oninput="Vistas.buscarProdStock()">
                    <div id="stock-results" class="mb-4" style="max-height:150px; overflow-y:auto; border:1px solid #eee; display:none;"></div>
                    
                    <div id="stock-form" class="hidden" style="border-top:1px solid #eee; padding-top:1rem;">
                        <label class="text-sm bold">Producto Seleccionado:</label>
                        <input type="text" id="s-imei" readonly style="background:#f3f4f6;">
                        
                        <label class="text-sm bold">Talla:</label>
                        <select id="s-talla"></select>
                        
                        <label class="text-sm bold">Cantidad a Crear:</label>
                        <input type="number" id="s-cant" placeholder="Ej: 10">
                        
                        <button class="btn btn-success w-full mt-2" onclick="Vistas.saveStock()">Generar Stock</button>
                    </div>
                    <button class="btn btn-secondary w-full mt-2" onclick="Vistas.cerrarModal()">Cerrar</button>
                `;
                Vistas.abrirModal(html);
            },

            buscarProdStock: () => {
                const q = document.getElementById('stock-search').value.toLowerCase();
                const res = document.getElementById('stock-results');
                res.innerHTML = '';
                res.style.display = 'block';

                if(q.length < 1) { res.style.display = 'none'; return; }

                const encontrados = db.getTabla('productos').filter(p => 
                    p.estado === 'Activo' && (p.imei.toLowerCase().includes(q) || p.nombre.toLowerCase().includes(q))
                );

                if(encontrados.length === 0) {
                    res.innerHTML = '<div class="p-2 text-red-500">No hay coincidencias</div>';
                    return;
                }

                encontrados.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `<b>${p.nombre}</b> (${p.imei})`;
                    item.onclick = () => Vistas.selectProdStock(p);
                    res.appendChild(item);
                });
            },

            selectProdStock: (prod) => {
                document.getElementById('stock-results').style.display = 'none';
                document.getElementById('stock-search').value = prod.nombre;
                
                document.getElementById('stock-form').classList.remove('hidden');
                document.getElementById('s-imei').value = prod.imei;
                
                const select = document.getElementById('s-talla');
                select.innerHTML = '';
                Utils.obtenerTallasPorTipo(prod.tipoTalla).forEach(t => {
                    select.innerHTML += `<option value="${t}">${t}</option>`;
                });
            },
            
            saveStock: () => {
                const imei = document.getElementById('s-imei').value;
                const cant = parseInt(document.getElementById('s-cant').value);
                const talla = document.getElementById('s-talla').value;
                
                if(!cant || cant <= 0) return alert("Cantidad inválida");

                for(let i=0; i<cant; i++) {
                    // ID Aleatorio corto
                    const idRandom = Utils.generarIdCorto();
                    db.insertar('productosFisicos', new ProductoFisico(idRandom, imei, talla));
                }
                db.insertar('historial', new HistorialCambio('Stock Físico', imei, sistema.usuarioActual.username, 'Ingreso', `${cant} unidades talla ${talla}`));
                Vistas.cerrarModal();
                sistema.navegar('almacen_stock');
            },

            // Utils
            abrirModal: (h) => { document.getElementById('modal-body').innerHTML=h; document.getElementById('modal-container').classList.remove('hidden'); },
            cerrarModal: () => { document.getElementById('modal-container').classList.add('hidden'); }
        };
    </script>
</body>
</html>